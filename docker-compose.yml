# feedman Docker Compose 構成
#
# 4コンテナ構成:
# - web:    Next.js フロントエンド（ポート3000を外部公開）
# - api:    Go APIサーバー（serveサブコマンド、ポート8080を外部公開）
# - worker: Goワーカー（workerサブコマンド）
# - db:     PostgreSQL 16
#
# ネットワーク設計:
# - internal: API <-> DB, Worker <-> DB の内部通信専用（外部通信不可）
# - external: Web, API（ポート公開用）とWorker（外部フィードフェッチ用）が接続
#   ※API自身はSSRFをアプリケーション層（safeurl）で防止

services:
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
    ports:
      - "${WEB_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
    networks:
      - external
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["serve"]
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER:-feedman}:${POSTGRES_PASSWORD:-feedman}@db:5432/${POSTGRES_DB:-feedman}?sslmode=disable
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL:-http://localhost:8080/auth/google/callback}
      - SESSION_SECRET=${SESSION_SECRET}
      - BASE_URL=${BASE_URL:-http://localhost:8080}
      - CORS_ALLOWED_ORIGIN=${CORS_ALLOWED_ORIGIN:-http://localhost:3000}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN:-}
      - SERVER_PORT=8080
      - LOG_RETENTION_DAYS=14
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "14"
    healthcheck:
      test: ["/feedman", "healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      db:
        condition: service_healthy
    networks:
      - internal
      - external
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["worker"]
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER:-feedman}:${POSTGRES_PASSWORD:-feedman}@db:5432/${POSTGRES_DB:-feedman}?sslmode=disable
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-dummy}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-dummy}
      - GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL:-http://localhost:8080/auth/google/callback}
      - SESSION_SECRET=${SESSION_SECRET:-dummy}
      - BASE_URL=${BASE_URL:-http://localhost:8080}
      - FETCH_TIMEOUT=${FETCH_TIMEOUT:-10s}
      - FETCH_MAX_SIZE=${FETCH_MAX_SIZE:-5242880}
      - FETCH_MAX_CONCURRENT=${FETCH_MAX_CONCURRENT:-10}
      - FETCH_INTERVAL=${FETCH_INTERVAL:-5m}
      - HATEBU_TTL=${HATEBU_TTL:-24h}
      - HATEBU_BATCH_INTERVAL=${HATEBU_BATCH_INTERVAL:-10m}
      - HATEBU_API_INTERVAL=${HATEBU_API_INTERVAL:-5s}
      - HATEBU_MAX_CALLS_PER_CYCLE=${HATEBU_MAX_CALLS_PER_CYCLE:-100}
      - LOG_RETENTION_DAYS=14
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "14"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - internal
      - external
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-feedman}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-feedman}
      - POSTGRES_DB=${POSTGRES_DB:-feedman}
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-feedman}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

networks:
  internal:
    driver: bridge
    internal: true
  external:
    driver: bridge

volumes:
  pgdata:
