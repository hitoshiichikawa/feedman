# Implementation Plan

- [ ] 1. プロジェクト基盤と環境設定のセットアップ
- [x] 1.1 Goプロジェクトの初期化と環境変数設定の読み込み機能を構築する
  - Goモジュールを初期化し、必要な依存ライブラリ（chi、gofeed、bluemonday、safeurl、gorilla/sessions、prometheus/client_golang、golang.org/x/time/rate）を追加する
  - 環境変数からDB接続、OAuth設定、フェッチ制限、並列数、レート制限、はてブTTLなどの設定値を読み込むConfig構造体を実装する
  - 必須環境変数が未設定の場合に起動時エラーで終了する仕組みを実装する
  - JSON構造化ログ出力をlog/slogで初期化し、アプリケーション全体のロガーをセットアップする
  - _Requirements: 16.1, 15.1_

- [x] 1.2 (P) Docker環境とdocker-composeの構成を構築する
  - Go APIサーバー、Goワーカー、PostgreSQLの3コンテナ構成のdocker-compose定義を作成する
  - Goのマルチステージビルド用Dockerfileを作成する（APIとWorkerはサブコマンドで起動分岐）
  - Docker networkによるegress制限を構成し、ワーカーコンテナのみ外部通信を許可する
  - _Requirements: 16.2, 12.3_

- [x] 1.3 データベーススキーマとマイグレーション基盤を構築する
  - golang-migrateを導入し、タイムスタンプベースのマイグレーション管理体制を構築する
  - users、identities、feeds、items、subscriptions、item_states、user_settings、sessionsテーブルの初期マイグレーションを作成する
  - 各テーブルのインデックス（部分インデックス含む）とユニーク制約を定義する
  - 外部キー制約のCASCADE削除設定を構成する
  - _Requirements: 16.3, 1.7, 6.1, 7.1_

- [ ] 2. 認証・セッション・セキュリティ基盤の構築
- [x] 2.1 Google OAuth認証フローを実装する
  - OAuthフロー開始（認証URL生成とリダイレクト）を実装する
  - OAuthコールバック処理（認可コードとトークンの交換、ユーザー情報取得）を実装する
  - 未登録ユーザーの場合にusersレコードとidentitiesレコードを同時に自動作成する
  - 登録済みユーザーの場合にidentitiesテーブルで既存ユーザーを特定しログインする
  - 認証成功時にHTTP Only Cookieベースのセッションを発行する
  - ログアウト機能（セッション破棄）を実装する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.7_

- [x] 2.2 セッション検証ミドルウェアとCSRF対策を実装する
  - HTTP Only Cookieからセッションを読み取り有効性を検証するミドルウェアを実装する
  - 認証済みユーザーIDをリクエストコンテキストに注入する仕組みを実装する
  - CSRFトークンの生成・検証ミドルウェアを実装し、SameSite=Lax属性を設定する
  - 状態変更リクエスト（POST/PUT/PATCH/DELETE）でCSRFトークン検証を必須化する
  - CSRFトークン取得エンドポイントを提供する
  - 原則同一オリジン動作とし、CORSは必要時のみ最小許可とする
  - _Requirements: 1.4, 1.5, 1.6, 1.8_

- [x] 2.3 (P) レート制限ミドルウェアを実装する
  - トークンバケット方式でユーザーごとのAPI全般レート制限（120リクエスト/分/ユーザー）を実装する
  - フィード登録エンドポイント固有のレート制限（10リクエスト/分/ユーザー）を実装する
  - 制限超過時に429 Too Many Requestsレスポンス（Retry-Afterヘッダー付き）を返す
  - 期限切れユーザーエントリの定期クリーンアップを実装する
  - _Requirements: 13.1, 13.2_

- [x] 2.4 (P) SSRF防止機能を実装する
  - safeurlライブラリを用いてSSRF防止付きHTTPクライアントを生成する機能を実装する
  - プライベートIPアドレス、リンクローカルアドレス、メタデータIPアドレス、ループバックアドレスへのリクエスト拒否を設定する
  - URL安全性の事前検証機能を実装する
  - DNS再バインディング攻撃への対策を有効化する
  - _Requirements: 12.1, 12.2_

- [x] 2.5 (P) コンテンツサニタイズ機能を実装する
  - bluemondayライブラリを用いて許可タグ（p, br, a, ul, ol, li, blockquote, pre, code, strong, em, img）のみを通過させるポリシーを定義する
  - script、iframe、styleタグおよびon*イベント属性の除去を設定する
  - imgタグのsrc属性をhttpsスキームのみに制限する
  - aタグにtarget="_blank"とrel="noopener noreferrer"を自動付与する
  - _Requirements: 11.1, 11.2, 11.3, 11.4_

- [ ] 3. フィード登録・管理機能の構築
- [x] 3.1 フィード自動検出と登録ロジックを実装する
  - 入力URLがRSS/AtomフィードかどうかをContent-Typeとボディ解析で判定する機能を実装する
  - HTML URLの場合にheadタグからRSS/Atomフィードリンクを解析・検出する機能を実装する
  - 複数候補検出時の優先順位ロジック（同一ホスト > Atom > RSS > 先頭）を実装する
  - フィード未検出時にエラーメッセージ（原因カテゴリ + 対処方法）を返す処理を実装する
  - フィード登録時にSSRF検証を実行する
  - _Requirements: 2.1, 2.2, 2.3, 2.6, 12.1_

- [x] 3.2 フィード・購読の永続化とfavicon取得を実装する
  - feedテーブルへのフィード保存（feed_urlでの重複チェック含む）を実装する
  - subscriptionテーブルへの購読レコード作成を実装する
  - ユーザーあたり購読上限100件のチェックと上限到達時のエラーレスポンスを実装する
  - フィード登録時にfaviconを取得しバイナリ保存する機能を実装する（取得失敗時はnullとして保存）
  - 登録後のフィードURL表示・変更機能を実装する
  - _Requirements: 2.4, 2.5, 2.7, 2.8_

- [x] 3.3 フィード管理APIエンドポイントを実装する
  - フィード登録（POST）、詳細取得（GET）、フィードURL変更（PATCH）、削除（DELETE）のエンドポイントを実装する
  - フィード登録エンドポイントに登録専用レート制限を適用する
  - 統一エラーフォーマット（APIError: code, message, category, action）でのレスポンスを実装する
  - _Requirements: 2.1, 2.4, 2.6, 2.8, 15.4_

- [ ] 4. 記事管理と状態管理機能の構築
- [x] 4.1 記事の同一性判定とUPSERT処理を実装する
  - 3段階の同一性判定ロジック（feed_id+guid_or_id、feed_id+link、hash(title+published+summary)）を実装する
  - 既存記事と同一と判定された場合の上書き更新処理を実装する
  - 新規記事挿入時のpublished_at未設定の場合にfetched_atを代用し推定フラグを付与する処理を実装する
  - 記事コンテンツにサニタイズ処理を適用してから保存する
  - _Requirements: 7.1, 7.2, 4.2, 11.1_

- [x] 4.2 記事一覧取得とフィルタリングを実装する
  - published_at降順でのカーソルベースページネーション（50件/回）を実装する
  - 3種のフィルタ（全て、未読のみ、スターのみ）によるクエリ分岐を実装する
  - ユーザーごとの記事状態（既読/スター）をitem_statesテーブルからJOINして返す
  - _Requirements: 4.1, 4.3, 5.1, 5.2, 5.3_

- [x] 4.3 記事詳細取得と状態管理APIを実装する
  - 記事詳細（サニタイズ済みHTML、元記事URL含む）取得エンドポイントを実装する
  - 記事の既読・スター状態を冪等に明示的更新するエンドポイント（PUTメソッド）を実装する
  - nilフィールドは変更しない部分更新のロジックを実装する
  - ユーザーデータ分離（全クエリにuser_id条件付与）をRepository層で強制する
  - _Requirements: 4.4, 4.5, 4.7, 6.1, 6.2, 6.3, 1.6_

- [ ] 5. 購読管理機能の構築
- [x] 5.1 購読一覧・設定・解除APIを実装する
  - ユーザーの購読一覧取得エンドポイント（フィードタイトル、favicon、フェッチステータス、未読数を含む）を実装する
  - フェッチ間隔設定の更新エンドポイント（30分-12時間、30分刻みのバリデーション）を実装する
  - 購読解除エンドポイント（subscription + 関連item_statesの削除）を実装する
  - _Requirements: 8.5, 14.2, 3.2_

- [x] 5.2 フィードフェッチ再開と退会処理を実装する
  - 停止中フィードの「再開」エンドポイント（fetch_statusをactiveに戻す）を実装する
  - 退会エンドポイント（user、identities、subscriptions、item_states、settingsを一括削除するトランザクション処理）を実装する
  - 退会時にfeeds、itemsを共有キャッシュとして残す設計を維持する
  - _Requirements: 9.5, 14.3, 14.4_

- [ ] 6. ワーカー: フィードフェッチ処理の構築
- [x] 6.1 フェッチスケジューラを実装する
  - 5分間隔のティッカーでnext_fetch_at <= now() かつ fetch_status = 'active' かつ購読者が存在するフィードを取得するスケジューラを実装する
  - FOR UPDATE SKIP LOCKEDによるPostgreSQLレベルの排他制御を実装する
  - semaphoreパターンで最大10ゴルーチンによる並列フェッチを制御する
  - _Requirements: 8.1, 8.2_

- [x] 6.2 フィードフェッチャーを実装する
  - ETag/Last-Modifiedを使用した条件付きGETでフィードを取得する機能を実装する
  - タイムアウト10秒、最大レスポンスサイズ5MBの制限を設定する
  - フェッチ時にSSRF検証を実行する
  - 取得したフィードをgofeedでパースし、サニタイズ後にItemUpsertServiceで記事を保存する
  - next_fetch_atを当該フィードの全subscriptionの最小fetch_interval_minutesで算出・更新する
  - _Requirements: 8.3, 8.4, 12.1_

- [x] 6.3 フェッチのリトライ・停止・バックオフ戦略を実装する
  - HTTPステータス404/410で即座にフェッチ停止（fetch_status = 'stopped'）する処理を実装する
  - HTTPステータス401/403で即座にフェッチ停止する処理を実装する
  - パース失敗の連続回数をカウントし、10回連続で停止する処理を実装する
  - HTTPステータス429/5xxに対する指数バックオフ（初回30分、最大12時間）を実装する
  - 停止/バックオフ時のerror_message記録とログ出力を実装する
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 15.1_

- [ ] 7. ワーカー: はてなブックマーク連携とデータライフサイクルの構築
- [x] 7.1 はてなブックマーク数の取得サービスを実装する
  - はてなブックマークAPIの一括取得エンドポイント（最大50URL/リクエスト）を呼び出す機能を実装する
  - ブックマーク数0件（空データ）のハンドリングを実装する
  - 取得失敗時に前回値を維持しエラーはログのみに記録する処理を実装する
  - _Requirements: 10.1, 10.3_

- [x] 7.2 はてなブックマーク数のバッチ取得ジョブを実装する
  - 10分間隔のティッカーでhatebu_fetched_atがNULLまたは24時間経過した記事を対象に取得ジョブを実行する
  - 未取得（hatebu_fetched_at IS NULL）を優先し、古い順に処理する優先度制御を実装する
  - 最低5秒のAPI呼び出しインターバルと1サイクルあたり最大100回のAPI呼び出し制限のスロットリング戦略を実装する
  - 連続エラー時のバックオフ（3回で30分、5回で1時間、10回で6時間待機）を実装する
  - スロットリングパラメータを環境変数で調整可能にする
  - _Requirements: 10.1, 10.2, 10.3, 16.1_

- [x] 7.3 (P) 記事データの180日保持と自動削除ジョブを実装する
  - 日次実行のバッチジョブでcreated_atから180日超過した記事と関連item_statesを削除する処理を実装する
  - 冪等な削除処理（削除済みレコードの再削除が影響なし）を保証する
  - _Requirements: 14.1_

- [ ] 8. メトリクスと観測性の構築
- [x] 8.1 Prometheusメトリクス収集と公開を実装する
  - fetch_success_count、fetch_fail_count、parse_fail_count（Counter）を定義・収集する
  - http_status_count（Counter、status_codeラベル付き）とfetch_latency（Histogram）を定義・収集する
  - items_upserted_count（Counter）を定義・収集する
  - /metricsエンドポイントでPrometheusスクレイプに対応する
  - _Requirements: 15.3_

- [x] 8.2 構造化ログとエラーハンドリングの統合を完成させる
  - 全コンポーネントでのJSON構造化ログ出力（user_id、feed_id、url、HTTPステータス、処理時間、エラー種別、取り込み件数）を統合する
  - ログ14日保持のための設定・ローテーションを構成する
  - UIエラー表示用の統一エラーフォーマット（原因カテゴリ + 対処方法）をAPIレスポンスに適用する
  - _Requirements: 15.1, 15.2, 15.4_

- [ ] 9. フロントエンド基盤とテーマの構築
- [x] 9.1 Next.jsプロジェクトの初期化とshadcn/ui環境の構築を行う
  - Next.js 15（App Router）プロジェクトを初期化する
  - Tailwind CSS 4とshadcn/uiコンポーネントを導入する
  - TanStack Query（React Query）のQueryClientProviderを設定する
  - _Requirements: 3.4_

- [x] 9.2 テーマ切替機能とCSRFトークン管理を実装する
  - ライト/ダークテーマ切替のProviderをTailwindのdark:クラスで実装する（デフォルトはライト）
  - テーマ設定のlocalStorage永続化を実装する
  - ページ初回読み込み時にCSRFトークンを取得しReact Contextで保持する仕組みを実装する
  - mutation系リクエストにX-CSRF-Tokenヘッダーを自動付与するAPI通信レイヤーを構築する
  - _Requirements: 3.5, 1.5_

- [ ] 10. フロントエンド: フィード管理UIの構築
- [x] 10.1 左ペインのフィード一覧パネルを実装する
  - フィード一覧をタイトルとfavicon（存在する場合）付きで表示するパネルを実装する
  - フィードのfetch_statusが停止/エラーの場合にアイコンで状態を表示する
  - フィード選択イベントを親コンポーネントに通知する仕組みを実装する
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 10.2 フィード登録ダイアログを実装する
  - URL入力欄1つでフィード登録を行うダイアログを実装する
  - 登録成功時にフィードURLを表示しユーザーが変更可能とする
  - エラー表示（フィード未検出、購読上限到達）を原因カテゴリと対処方法付きで実装する
  - _Requirements: 2.1, 2.4, 2.6, 2.8, 15.4_

- [ ] 11. フロントエンド: 記事閲覧UIの構築
- [x] 11.1 右ペインの記事一覧パネルを実装する
  - フィード選択に応じた記事一覧をpublished_at降順で表示する
  - 推定フラグ付き日付の表示（fetched_at代用時）を実装する
  - useInfiniteQueryとIntersection Observerによる無限スクロール（50件/回）を実装する
  - フィルタ切替UI（全て/未読/スター）を実装する
  - _Requirements: 4.1, 4.2, 4.3, 5.1, 5.2, 5.3_

- [x] 11.2 記事展開表示と操作機能を実装する
  - 記事クリックで同ペイン内にサニタイズ済みHTMLコンテンツを展開表示する
  - 排他的展開（1件のみ展開、新規展開で前回を閉じる）を実装する
  - 展開時に自動的に既読状態にするAPI呼び出しを実装する
  - 元記事URLへの遷移ボタンを実装する
  - はてなブックマーク数の表示（未取得時は「-」表示）を実装する
  - スター切替の楽観的更新を実装する
  - _Requirements: 4.4, 4.5, 4.6, 4.7, 6.2, 6.3, 10.1_

- [ ] 12. フロントエンド: 購読管理・設定UIの構築
- [x] 12.1 購読設定と管理UIを実装する
  - フェッチ間隔設定の変更UI（30分-12時間、30分刻みのスライダー/セレクト）を実装する
  - 購読解除の確認ダイアログと実行機能を実装する
  - 停止中フィードの「再開」ボタンを実装する
  - _Requirements: 8.5, 9.5, 14.2_

- [x] 12.2 (P) 退会機能とエラー表示コンポーネントを実装する
  - 退会の確認ダイアログと実行機能（認証解除 + リダイレクト）を実装する
  - エラー表示コンポーネント（原因カテゴリ + 対処方法の提示）を実装する
  - _Requirements: 14.3, 15.4_

- [ ] 13. フロントエンド: 認証UIの構築
- [x] 13.1 ログイン・ログアウトUIを実装する
  - Googleアカウントでのログイン/登録ボタンとOAuthフローへの遷移を実装する
  - ログアウト機能（セッション破棄 + リダイレクト）を実装する
  - 未認証状態でのリダイレクトハンドリングを実装する
  - _Requirements: 1.1, 1.3_

- [ ] 14. 全体統合と2ペインレイアウトの完成
- [x] 14.1 AppShellと2ペインレイアウトの統合を完成させる
  - 左ペイン（フィード一覧）と右ペイン（記事一覧）の2ペイン分割レイアウトを構築する
  - 各Provider（QueryClientProvider、ThemeProvider、AppStateProvider）のラップ構成を完成させる
  - 選択フィード、展開記事ID、フィルタ状態のUIステートをReact Context + useReducerで一元管理する
  - _Requirements: 3.1, 3.3_

- [x] 14.2 APIルーティングとミドルウェアチェーンの統合を完成させる
  - Chi Routerで全APIエンドポイントのルーティングを構成する
  - ミドルウェアスタック（SessionMiddleware → CSRFMiddleware → RateLimitMiddleware）の実行順序を検証・確定する
  - APIサーバーとワーカーのサブコマンド起動分岐を実装する
  - _Requirements: 1.4, 1.5, 1.8, 13.1, 13.2_

- [x] 14.3 エンドツーエンド統合テストを実施する
  - OAuth認証フロー（ログイン → セッション発行 → 認証済みアクセス → ログアウト）の統合テストを実装する
  - フィード登録フロー（URL入力 → フィード検出 → DB保存 → 購読作成）の統合テストを実装する
  - ワーカーフェッチフロー（スケジューラ → フェッチ → パース → UPSERT → next_fetch_at更新）の統合テストを実装する
  - 購読解除・退会フロー（データ削除の整合性確認）の統合テストを実装する
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 8.1, 8.2, 14.2, 14.3, 14.4_
